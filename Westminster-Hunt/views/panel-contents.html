<h2>Categories</h2>
<ul data-role="listview" id="mission-categories" class="ui-nodisc-icon">
  <li><a href="#" view="Campuses" class="ui-alt-icon">Campuses</a></li>
  <li><a href="#" view="Essentials" class="ui-alt-icon">Essentials</a></li>
  <li><a href="#" view="People" class="ui-alt-icon">People</a></li>
  <li><a href="#" view="Study" class="ui-alt-icon">Study</a></li>
</ul>
<table id="nav-buttons">
  <tr>
    <td view="Newsletter">Newsletter</td>
    <td view="Guide">Guide</td>
  </tr>
  <tr>
    <td view="Map">Map of Campuses</td>
    <td view="fav">Favourites</td>
  </tr>
</table>

<script>
  currentCategory = null;
  currentId = null;


  // function to dynamically load new pages using AJAX
  loadCategory = function() {
    categoryName = $(this).attr("view");
    // console.log("c " + categoryName);

    // make element active
    $('.active-btn').addClass('ui-alt-icon').removeClass('active-btn');
    $(this).addClass('active-btn').removeClass('ui-alt-icon');

    // loadOff view listeners

    // load ajax
    retrievedCategory = null;
    currentCategory = categoryName;
    currentId = 1;
    $.ajax({
      url: "views/missionList.html"
    })
    .done(function(data) {
      $('#content-frame').html(data);
      $('li a[href="#tab-' + categoryName + '"]').click();

      if (localStorage.getItem(categoryName) == null)
      {
        $.ajax({
          url: "models/" + categoryName + ".json"
        })
        .done(function( data ) {
          console.log("data");
          console.log(data);
          // save JSON as string in localStorage
          localStorage.setItem(categoryName, JSON.stringify(data));
          retrievedCategory = data;
          // dynamically create content
          drawChests(retrievedCategory);
          // loadQuestion(1, data);
        })
        .error(function(data, categoryName) {
          var r = jQuery.parseJSON(data.responseText);
          console.log(r);
        });
      }
      else {
        retrievedCategory = JSON.parse(localStorage.getItem(categoryName));
        console.log("saved");
        console.log(retrievedCategory);
        // dynamically create content
        drawChests(retrievedCategory, categoryName);
        // loadQuestion(currentId, retrievedCategory);
      }
    });
  };

  drawChests = function(data, name) {
    currentMission = eval("retrievedCategory.questions");
    // console.log(currentMission);

    // drawChests
    for(var propName in currentMission) {
      mission = eval("currentMission." + propName);
      html = chest_closed;
      $('#tab-' + name + ' ul').append(html).find('span').last().html('' + mission.title);
    }
  };

  loadView = function() {
    viewName = $(this).attr("view");
    console.log("v " + viewName);

    // make element active
    $('.active-btn').addClass('ui-alt-icon').removeClass('active-btn');
    $(this).addClass('active-btn').removeClass('ui-alt-icon');

    // loadOff view listeners

    // load ajax;
    $.ajax({
      url: "views/" + viewName + ".html"
    })
    .done(function( data ) {
      changePageTitle(viewName);
      $('#content-frame').html(data);
    });
  };

  // assigning listeners
  $('#mission-categories li a').click(loadCategory);
  $("#nav-buttons tr td").click(loadView);


  // loadOff to be run when the view is changed, to shut down listeners
  loadOffPanned = function() {
    $('#mission-categories li a').unbind();
  };

  changePageTitle = function(newName) {
    $('#title').html(newName);
  }

// should be in questions controller
  var correctAnswer = null;
  var userScore = 0;
  loadQuestion = function(id, retrievedCategory) {
    $.ajax({
      url: "views/questionPage.html"
    })
    .done(function( dataPage ) {
      changePageTitle("Question");
      $('#content-frame').html(dataPage);
      displayQuestion(id, retrievedCategory);
    });
  };
  displayQuestion = function(id, retrievedCategory) {
    mod = 1; //awlays int - test
    if (id < 1) return;
    // console.log(currentCategory);
    // console.log(retrievedCategory);
    currentQuestion = eval("retrievedCategory.questions.m" + mod + '.q' + id);
    console.log(currentQuestion);
    if (currentQuestion.answersType == 'text'){
      // answers are text
      $('#answers-pic').hide();
      $("#question").html(currentQuestion.title);
      $("#opt-a").html(currentQuestion.answers.a);
      $("#opt-b").html(currentQuestion.answers.b);
      $("#opt-c").html(currentQuestion.answers.c);
      $("#opt-d").html(currentQuestion.answers.d);
      correctAnswer = currentQuestion.correct;
    }
    else if (currentQuestion.answersType == 'image') {
      // answers are images
      $('#answers').remove();
      $("#question").html(currentQuestion.title);
      console.log(currentQuestion.answers.a);
      // $("#opt-a").css('background', 'url(http://ianfarb.com/wp-content/uploads/2013/10/nicholas-hodag.jpg)');
      $("#opt-a").css('background', 'url(models/' + currentQuestion.answers.a + ')');
      // $("#opt-a").attr('src', 'models/' + currentQuestion.answers.a);
      $("#opt-b").attr('src', 'models/' + currentQuestion.answers.a);
      $("#opt-c").attr('src', 'models/' + currentQuestion.answers.a);
      $("#opt-d").attr('src', 'models/' + currentQuestion.answers.a);
      correctAnswer = currentQuestion.correct;

    }
  };
  addToScoreAndUpdate = function() {
    userScore += 10;
    $('#panelPoints').html(userScore).addClass('hulk');
    setTimeout(function(){
      $('#panelPoints').removeClass('hulk');
    }, 500);
  };
// end of questions controller
</script>
